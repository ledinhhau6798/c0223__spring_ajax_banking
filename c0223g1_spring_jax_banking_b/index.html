<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List of customers</title>
    <link rel="stylesheet" href="./assets/bootstrap/v-5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets//fontawesome/v-5.15.4/css/all.min.css">
    <link rel="stylesheet" href="./assets/sweetalert2/sweetalert2.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar navbar-expand-lg bg-body-navbar">
                <div class="container-fluid">
                    <h1 class="navbar-brand">List of customers</h1>
                    <div class="collapse navbar-collapse" id="navbarScroll">
                        <div class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll"
                            style="--bs-scroll-height: 100px;">
                        </div>
                        <form class="d-flex" role="search">
                            <button type="button" class="btn btn-outline-light " id="btnHistoryTransfer">
                                <i class=" fa fa-history" aria-hidden="true"></i>
                                <span>Transfer Information</span>
                            </button>
                            <button class="btn btn-outline-light" type="button" id="btnShowCreateModal">Create</button>
                        </form>
                    </div>
                </div>
            </nav>
        </header>

        <table class="table table-hover" id="tbCustomer" >
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Full Name</th>
                <th scope="col">Email</th>
                <th scope="col">Phone</th>
                <th scope="col">Balance</th>
                <th scope="col">Address</th>
                <th class="text-center"scope="col-5">Action</th>
              </tr>
            </thead>
            <tbody>
              
            </tbody>
          </table>

     <!-- Modal create -->
    <div class="modal fade" id="modalCreate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"

    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Modal create customer</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="forms-sample" method="post" id="frmCreate">
                    <div class="row">
                        <div class="form-group col-6">
                            <label for="fullNameCre">Full Name</label>
                            <input type="text" class="form-control" id="fullNameCre"
                                placeholder="Enter Name">
                        </div>
                        <div class="form-group col-6">
                            <label for="emailCre">Email</label>
                            <input type="email" class="form-control" id="emailCre" 
                                placeholder="Enter Email">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="form-group col-6">
                            <label for="phoneCre">Phone</label>
                            <input type="tel" class="form-control" id="phoneCre"
                                placeholder="Enter Phone">
                        </div>
                        <div class="form-group col-6">
                            <label for="addressCre">Address</label>
                            <input type="text" class="form-control" id="addressCre" 
                                placeholder="Enter Address">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnCreate" class="btn btn-outline-primary">Create</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal update -->
    <div class="modal fade" id="modalUpdate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Modal update customer</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="error-area" style="color: red;"></div>
                <form method="post">
                    <div class="row mb-3">
                        <div class="col-lg-6">
                            <label class="fw-bold">Full Name</label>
                            <input type="text" class="form-control" id="fullNameUp">
                        </div>
                        <div class="col-lg-6">
                            <label class="fw-bold">Email</label>
                            <input type="email" class="form-control" id="emailUp">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-lg-6">
                            <label class="fw-bold">Phone</label>
                            <input type="tel" class="form-control" id="phoneUp">
                        </div>
                        <div class="col-lg-6">
                            <label class="fw-bold">Address</label>
                            <input type="text" class="form-control" id="addressUp">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnUpdate" class="btn btn-primary">Update</button>
            </div>
        </div>
    </div>
    </div>
    <!-- Modal deposit -->
    <div class="modal fade " id="modalDeposit" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Modal Deposit customer</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="error-area" style="color: red;"></div>
                <form method="post">
                    <div class="row mb-3">
                        <div class="col-lg-6">
                            <label class="fw-bold">Full Name</label>
                            <input type="text" class="form-control" id="fullNameDep">
                        </div>
                        <div class="col-lg-6">
                            <label class="fw-bold">Email</label>
                            <input type="email" class="form-control" id="emailDep">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-lg-6">
                            <label class="fw-bold">Transaction Amount</label>
                            <input type="number" class="form-control" id="transactionAmountDep"> 
                        </div>
                        <div class="col-lg-6">
                            <label class="fw-bold">Balance</label>
                            <input type="text" class="form-control" id="balanceDep">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnDeposit" class="btn btn-primary">Deposit</button>
            </div>
        </div>
    </div>
    </div>

     <!-- Modal withdraw -->
    <div class="modal fade " id="modalWithdraw" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
     aria-hidden="true">
     <div class="modal-dialog modal-lg modal-dialog-centered">
         <div class="modal-content">
             <div class="modal-header">
                 <h1 class="modal-title fs-5">Modal withdraw customer</h1>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <div class="modal-body">
                 <div class="error-area" style="color: red;"></div>
                 <form method="post">
                     <div class="row mb-3">
                         <div class="col-lg-6">
                             <label class="fw-bold">Full Name</label>
                             <input type="text" class="form-control" id="fullNameWi">
                         </div>
                         <div class="col-lg-6">
                             <label class="fw-bold">Email</label>
                             <input type="email" class="form-control" id="emailWi">
                         </div>
                     </div>
                     <div class="row mb-3">
                         <div class="col-lg-6">
                             <label class="fw-bold">Transaction Amount</label>
                             <input type="number" class="form-control" id="transactionAmountWi"> 
                         </div>
                         <div class="col-lg-6">
                             <label class="fw-bold">Balance</label>
                             <input type="text" class="form-control" id="balanceWi">
                         </div>
                     </div>
                 </form>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                 <button type="button" id="btnWithdraw" class="btn btn-primary">Withdraw</button>
             </div>
         </div>
     </div>
    </div>

      <!-- Modal Transfer -->
    <div class="modal fade " id="modalTransfer" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
      aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h1 class="modal-title fs-5">Modal Transfer customer</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <div class="error-area" style="color: red;"></div>
                  <form method="post">
                    <div class="row mt-3">
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label class="form-label">Sender ID</label>
                            <input type="number" class="form-control" id="senderIDT"
                                    readonly
                            >
                        </div>
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label  class="form-label">Sender Name</label>
                            <input type="text" class="form-control" id="senderNameT"
                                   readonly
                            >
                        </div>
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label class="form-label">Sender Email</label>
                            <input type="email" class="form-control" id="emailT"
                                    readonly
                            >
                        </div>
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label  class="form-label">Sender Balance</label>
                            <input type="number" class="form-control" id="balanceT"
                                   readonly
                            >
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label class="form-label">Recipient Name</label>
                            
                            
                            
                            <select class="form-select" name="recipient.id" id="recipientSelect" >
                                <option value="" selected disabled>Select recipient</option>
                            </select>
                            


                        </div>
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label  class="form-label">Transfer Amount (VND)</label>
                            <input type="number" class="form-control" id="transfer"  >
                        </div>
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label  class="form-label">Fee (%)</label>
                            <input type="number" class="form-control" id="fees"  readonly>
                        </div>
                        <div class="mb-3 float-left col-lg-3 col-sm-12 col-md-6">
                            <label class="form-label">Total Amount (VND)</label>
                            <input type="number" class="form-control" id="total" readonly>
                        </div>
                    </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" id="btnTransfer" class="btn btn-outline-warning">Transfer</button>
              </div>
          </div>
      </div>
    </div>

      <!-- Modal History Transfer -->
    <div class="modal fade" id="mdHistoryTransfer" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
            data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Modal History Transfer</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table id="tbHistoryTransfer" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Id</th>
                                    <th>Sender ID</th>
                                    <th>Recipient ID</th>
                                    <th>Fees (%)</th>
                                    <th>Fees Amount</th>
                                    <th>Transfer Amount</th>
                                    <th>Transaction Amount</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
    </div>

    </div>

    <script src="./assets/jquery/jquery-3.6.4.min.js"></script>
    <script src="./assets/bootstrap/v-5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/sweetalert2/sweetalert2.all.min.js"></script>

    <script src="./assets/js/bootstrap/app.js"></script>
<script>

    const page = {
        url: {
            getAllCustomers: App.API_CUSTOMER +'?deleted=0',
            getCustomerById: App.API_CUSTOMER,

            createCustomer: App.API_CUSTOMER,
            updateCustomer:App.API_CUSTOMER,
            depositCustomer: App.API_CUSTOMER,
            withdrawCustomer: App.API_CUSTOMER,
            transferCustomer: App.API_CUSTOMER,
            deleteCustomer:App.API_CUSTOMER,
        },
        elements:{},
        loadData:{},
        commands:{},
        dialogs:{
            elements:{},
            commands:{}
        },
        initializeControlEvent: {}
    }



        let customerId = 0;
        let customer = new Customer();
        let deposit = new Deposit();
        let withdraw = new Withdraw();
        let transfer = new Transfer();


        page.elements.btnShowCreateModal = $('#btnShowCreateModal');
        page.elements.tbCustomerBody = $('#tbCustomer tbody');

        page.dialogs.elements.modalCreate = $('#modalCreate');
        page.dialogs.elements.frmCreate = $('#frmCreate');
        page.dialogs.elements.fullNameCre = $('#fullNameCre');
        page.dialogs.elements.emailCre = $('#emailCre');
        page.dialogs.elements.phoneCre = $('#phoneCre');
        page.dialogs.elements.addressCre = $('#addressCre');
        page.dialogs.elements.btnCreate = $('#btnCreate');

        page.dialogs.elements.modalUpdate = $('#modalUpdate');
        page.dialogs.elements.fullNameUp = $('#fullNameUp');
        page.dialogs.elements.emailUp = $('#emailUp');
        page.dialogs.elements.phoneUp = $('#phoneUp');
        page.dialogs.elements.addressUp = $('#addressUp');
        page.dialogs.elements.btnUpdate = $('#btnUpdate');

        page.dialogs.elements.modalDeposit = $('#modalDeposit');
        page.dialogs.elements.fullNameDep = $('#fullNameDep');
        page.dialogs.elements.emailDep = $('#emailDep');
        page.dialogs.elements.balanceDep = $('#balanceDep');
        page.dialogs.elements.transactionAmountDep = $('#transactionAmountDep');
        page.dialogs.elements.btnDeposit = $('#btnDeposit');

        page.dialogs.elements.modalWithdraw = $('#modalWithdraw');
        page.dialogs.elements.fullNameWi = $('#fullNameWi');
        page.dialogs.elements.emailWi = $('#emailWi');
        page.dialogs.elements.balanceWi = $('#balanceWi');
        page.dialogs.elements.transactionAmountWi = $('#transactionAmountWi');
        page.dialogs.elements.btnWithdraw = $('#btnWithdraw');

        page.dialogs.elements.modalTransfer = $('#modalTransfer');
        page.dialogs.elements.senderIDT = $('#senderIDT');
        page.dialogs.elements.senderNameT = $('#senderNameT');
        page.dialogs.elements.emailT = $('#emailT');
        page.dialogs.elements.balanceT = $('#balanceT');
        page.dialogs.elements.recipientSelect = $('#recipientSelect');
        page.dialogs.elements.transfer = $('#transfer');
        page.dialogs.elements.fees = $('#fees');
        page.dialogs.elements.total = $('#total');
        page.dialogs.elements.btnTransfer = $('#btnTransfer');

        page.dialogs.elements.tbHistoryTransfer = $('#tbHistoryTransfer');
        page.dialogs.elements.mdHistoryTransfer = $('#mdHistoryTransfer');


        let id = 1;
        
        page.commands.renderCustomer = (obj) => {
            return `
                <tr id="tr_${obj.id}">
                    <th scope="row">${obj.id}</th>
                    <td>${obj.fullName}</td>
                    <td>${obj.email}</td>
                    <td>${obj.phone}</td>
                    <td>${obj.balance}</td>
                    <td>${obj.address}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-secondary edit" 
                            data-id="${obj.id}"
                        >
                            <i class="fa fa-pencil-alt"></i>
                        </button>
                        <button class="btn btn-outline-success deposit"
                            data-id="${obj.id}"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-outline-warning withdraw"
                            data-id="${obj.id}"
                        >
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-outline-primary transfer"
                            data-id="${obj.id}"
                        >
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-outline-danger delete"
                            data-id="${obj.id}"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `
        }

        // hiển thị danh sách
        page.commands.getAllCustomers = () => {
            page.elements.tbCustomerBody.empty();
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type:'GET',
                url: page.url.getAllCustomers
            })
            .done((data) => {
                data.forEach(item => {
                    const str = page.commands.renderCustomer(item);
                    page.elements.tbCustomerBody.prepend(str);
                });

            }) 
            .fail((error) => {
                console.log(error);
            })
        }
        

        // thêm
        page.dialogs.commands.create = () =>{
            const fullName = page.dialogs.elements.fullNameCre.val()
            const email = page.dialogs.elements.emailCre.val()
            const phone = page.dialogs.elements.phoneCre.val()
            const address = page.dialogs.elements.addressCre.val()
            const balance = +0
            const deleted = +0

            const obj = {
                fullName,
                email,
                phone,
                balance,
                address,
                deleted
            }
            

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.createCustomer,
                data:  JSON.stringify(obj)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data)
                    
                    page.elements.tbCustomerBody.prepend(str)
                    
                    page.dialogs.elements.modalCreate.modal('hide')
                    App.showSuccessAlert('Đã thêm tài khoản')
                    
                })
                .fail((error) => {
                    console.log(error);
                })
               
        
        }

        // lấy id
        page.commands.getCustomerById = (id) => {
            return $.ajax({
                url: page.url.getCustomerById + '/' + id,
            })
        }

        // mở Edit
        page.commands.handleAddEventShowModalUpdate = (customerId) => {
           page.commands.getCustomerById(customerId).then((data) => {
            page.dialogs.elements.fullNameUp.val(data.fullName);
            page.dialogs.elements.emailUp.val(data.email);
            page.dialogs.elements.phoneUp.val(data.phone);
            page.dialogs.elements.addressUp.val(data.address);

            page.dialogs.elements.modalUpdate.modal('show');
           }) 
                    .catch((error) => {
                        console.log(error)
                    })
                
           
        }

        // mở deposit
        page.commands.handleAddEventShowModalDeposit = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                page.dialogs.elements.fullNameDep.val(data.fullName);
                page.dialogs.elements.emailDep.val(data.email);
                page.dialogs.elements.balanceDep.val(data.balance);

                page.dialogs.elements.modalDeposit.modal('show');
               
            })
            .catch((error) => {
                console.log(error);
            })
        }

        // mở withdraw
        page.commands.handleAddEventShowModalWithdraw =(customerId) =>{
            page.commands.getCustomerById(customerId).then((data) =>{
                page.dialogs.elements.fullNameWi.val(data.fullName);
                page.dialogs.elements.emailWi.val(data.email);
                page.dialogs.elements.balanceWi.val(data.balance);

                page.dialogs.elements.modalWithdraw.modal('show');
            })
            .catch((error) => {
                console.log(error);
            })
        }

        // lấy id trong recipient chuyển sang name trong select option
        page.commands.getRecipients = (customerId) => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'GET',
                url: page.url.transferCustomer,
                dataType: 'json',
                success: function (customers) {
                    
                    var recipientSelect =page.dialogs.elements.recipientSelect;
                    recipientSelect.empty();
                    recipientSelect.append($('<option>').val('').text('Select recipient'));

                    $.each(customers, function (index, customer) {
                        
                        if (customer.id !== customerId && customer.deleted === 0) {
                            recipientSelect.append($('<option>').val(customer.id).text(customer.id + ' - ' + customer.fullName));
                        }
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error: ' + textStatus + ' ' + errorThrown);
                }
            });
        }

        // mở transfer
        page.commands.handleAddEventShowModalTransfer = () => {
            page.commands.getCustomerById(customerId).then((data) =>{
                page.dialogs.elements.senderIDT.val(data.id)
                page.dialogs.elements.senderNameT.val(data.fullName)
                page.dialogs.elements.emailT.val(data.email)
                page.dialogs.elements.balanceT.val(data.balance)
                page.commands.getRecipients(customerId);
                page.dialogs.elements.transfer.val();
                page.dialogs.elements.fees.val(10);
                page.dialogs.elements.total.val();

                page.dialogs.elements.modalTransfer.modal('show');
            })
            .catch((error) => {
                console.log(error);
            })

        }
        
        
        
        // chạy Edit
        page.dialogs.commands.update = () => {
            let fullName = page.dialogs.elements.fullNameUp.val()
            let email =page.dialogs.elements.emailUp.val()
            let phone = page.dialogs.elements.phoneUp.val()
            let address =page.dialogs.elements.addressUp.val()
            
            const customer = {
                fullName,
                email,
                phone,
                address,
                
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.updateCustomer + '/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data)
                    $('#tr_' + customerId).replaceWith(str)
                    page.dialogs.elements.modalUpdate.modal('hide')
 

                })
                .fail((jqXHR) => {
                    const responseJSON = jqXHR.responseJSON

                    let str = '<ul>'
                    $.each(responseJSON, (k, v) => {
                        str += `<li>${v}</li>`
                    })

                    str += '</ul>'


                    $('.error-area').empty().append(str);
                })
        }


        // chạy Deposit
        page.dialogs.commands.deposit = () =>{
            let transactionAmount = +page.dialogs.elements.transactionAmountDep.val()
            let balance = transactionAmount + +page.dialogs.elements.balanceDep.val();

            const deposit = {
            
            transactionAmount,
            balance
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type:'PATCH',
                url:page.url.depositCustomer + '/' + customerId,
                data: JSON.stringify(deposit)
            })
            .done((data) => {
                const str = page.commands.renderCustomer(data)
                    $('#tr_' + customerId).replaceWith(str)
                    page.dialogs.elements.modalDeposit.modal('hide')
                    App.showSuccessAlert('nạp tiền thành công')
            })
            .fail((error)=> {
                console.log(error);
            })
        }

        

        // chạy Withdraw
        page.dialogs.commands.withdraw = () =>{
            let transactionAmount = +page.dialogs.elements.transactionAmountWi.val();
            let balance = page.dialogs.elements.balanceWi.val() - transactionAmount;

            const withdraw ={
                transactionAmount,
                balance
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type:'PATCH',
                url:page.url.withdrawCustomer + '/' + customerId,
                data: JSON.stringify(withdraw)

            })
            .done((data) => {
                const str = page.commands.renderCustomer(data)
                    $('#tr_' + customerId).replaceWith(str)
                    page.dialogs.elements.modalWithdraw.modal('hide')
                    App.showSuccessAlert('rút tiền thành công')
            })
            .fail((error)=> {
                console.log(error);
            })
        }

        // chạy Transfer
        page.dialogs.commands.transfer =() => {
            let recipientId = page.dialogs.elements.recipientSelect.val();
            
            page.commands.getCustomerById(customerId).then((data) =>{
                
                let customer = data;
                let currenBalance = customer.balance;
                let transactionAmount = +page.dialogs.elements.total.val();
                
                let newBalance = currenBalance - transactionAmount;
               
                customer.balance = newBalance;
                
                page.commands.getCustomerById(recipientId).then((data) =>{
                    
                    let recipient = data;
                    
                    
                    let transferAmount = +page.dialogs.elements.transfer.val();
                    let currentBalanceRecipient = recipient.balance;                   
                    let newBalanceRecipient = transferAmount + currentBalanceRecipient;
                    recipient.balance = newBalanceRecipient;

                    let fees = +page.dialogs.elements.fees.val();
                    let feesAmount = (fees * transactionAmount) / 100;

                    // lấy dữ liệu để chuyển qua transfer hitory
                    let transfer = {
                        senderId: customer.id,
                        recipientId: recipient.id,
                        fees: fees,
                        feesAmount: feesAmount,
                        transferAmount: transferAmount,
                        transactionAmount: transactionAmount
                        
                    }

                    $.ajax({
                        headers: {
                            'accept': 'application/json',
                            'content-type': 'application/json'
                        },
                        type: 'PATCH',
                        url: page.url.transferCustomer + '/' + recipient.id,
                        data: JSON.stringify(recipient)

                    })
                    .done((data) => {
                        let str = page.commands.renderCustomer(data);
                        $('#tr_' + recipient.id).replaceWith(str);
                        // page.dialogs.elements.modalTransfer.modal('hide')
                    }) 
                    // đưa dữ liệu sang trang transfer hitory
                    $.ajax({
                            type: 'POST',
                            headers: {
                                'accept': 'application/json',
                                'content-type': 'application/json'
                            },
                            url: App.API_TRANSFER,
                            data: JSON.stringify(transfer)
                        })  
                })
                $.ajax({
                    type:'PATCH',
                    headers:{
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    url: page.url.transferCustomer + '/' + customer.id,
                    data:JSON.stringify(customer)
                })
                .done((data)=>{
                    let str = page.commands.renderCustomer(data);
                    $('#tr_' + customerId).replaceWith(str);

                    page.dialogs.elements.transfer.val();
                    page.dialogs.elements.total.val();
                    page.dialogs.elements.modalTransfer.modal('hide');
                    App.showSuccessAlert('chuyển tiền thành công')
                })
            })
        }
        


        


        // show delete
        page.commands.handleAddEventConfirmDelete = () => {
           
                customerId = $(this).data('id')

                Swal.fire({
                    title: 'bạn có muốn xóa?',
                    text: "xóa đi còn chờ gì nữa?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        doDelete(customerId).then(() => {
                            $('#tr_' + customerId).remove()

                            Swal.fire({
                                position: 'top-end',
                                icon: 'success',
                                title: 'xóa thành công',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        })
                            .catch((error) => {
                                console.log(error);
                            })
                    }
                })
            
        }
        // sửa deleted về 1
        const doDelete = (id) => {
            const obj = {
                deleted: 1
            }

            return $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.deleteCustomer + '/' + id,
                data: JSON.stringify(obj)
            })
        }

        page.dialogs.commands.closeModalCreate = () => {
                page.dialogs.elements.frmCreate[0].reset();
            }

        // page.dialogs.commands.closeModalTransfer = () => {
        //         page.dialogs.elements.transfer[0].reset();
        //     }

        // --------------------------------------------------------------------------------------------------


        page.commands.renderTransfer = (obj) => {
            return `<tr id='trDP_${obj.id}'>
            <td>${obj.id}</td>
            <td>${obj.senderId}</td>
            <td>${obj.recipientId}</td>
            <td>${obj.fees}</td>
            <td>${obj.feesAmount}</td>
            <td>${obj.transferAmount}</td>
            <td>${obj.transactionAmount}</td>
        </tr>`
                ;
        }


        // show Transfer hitory
        page.commands.getAllTransfer = () => {
            
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'GET',
                url: App.API_TRANSFER
            })
                .done((data) => {
                    let str = '';
                    $.each(data, (index, item) => {
                        str += renderTransfer(item);
                    })
                    $('#tbHistoryTransfer tbody').empty(str)
                    $('#tbHistoryTransfer tbody').append(str)
                    $('#mdHistoryTransfer').modal('show');
                })
                .fail((error) => {
                    console.error(error);
                })
        }
        


        


        $('#btnHistoryTransfer').on('click', function () {
            getAllTransfer();
        });



        // điều chỉnh total tăng thêm nhập số tiền
        document.addEventListener("input", () => {
            let fee = Number(document.getElementById("fees").value);
            let transferAmount = Number(document.getElementById("transfer").value);
            let transactionFee = transferAmount * fee / 100;
            document.getElementById("total").value = Math.round(transactionFee + transferAmount);
        })




        page.initializeControlEvent = () => {
            page.elements.btnShowCreateModal.on('click', () => {
                page.dialogs.elements.modalCreate.modal('show');
            }),

            page.dialogs.elements.btnCreate.on('click', () => {
                page.dialogs.commands.create(); 
            })
            page.elements.tbCustomerBody.on('click', '.edit', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalUpdate(customerId);
            })
            page.dialogs.elements.btnUpdate.on('click', () => {
                page.dialogs.commands.update(); 
            })

            page.elements.tbCustomerBody.on('click', '.deposit', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalDeposit(customerId);
            })

            page.dialogs.elements.btnDeposit.on('click', () => {
                page.dialogs.commands.deposit(); 
            })

            page.elements.tbCustomerBody.on('click', '.withdraw', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalWithdraw(customerId);
            })

            page.dialogs.elements.btnWithdraw.on('click', () => {
                page.dialogs.commands.withdraw();
            })

            page.elements.tbCustomerBody.on('click', '.transfer', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalTransfer(customerId);
            })

            page.dialogs.elements.btnTransfer.on('click', () =>{
                page.dialogs.commands.transfer();
            })

            page.elements.tbCustomerBody.on('click', '.delete', function () {
                customerId =$(this).data('id');
                page.commands.handleAddEventConfirmDelete();

            })

            page.dialogs.elements.modalCreate.on("hidden.bs.modal", function () {
                page.dialogs.commands.closeModalCreate();
            });

            // page.dialogs.elements.modalTransfer.on("hidden.bs.modal", function () {
            //     page.dialogs.commands.closeModalTransfer();
            // });

        }

        page.loadData = () => {
            page.commands.getAllCustomers();
        }

        $(() => {
            page.loadData();

            page.initializeControlEvent();
        })
</script>

</body>
</html>